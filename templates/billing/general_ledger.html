{% extends 'billing/base.html' %}
{% block title %}General Ledger - Macrohon Water Billing{% endblock %}
{% block page_title %}General Ledger{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h4><i class="fa fa-book"></i> General Ledger</h4>
        <small class="text-muted">All Financial Transactions</small>
    </div>
    <div class="col-md-4 text-right">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="fa fa-print"></i> Print
        </button>
        <button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#filterPanel">
            <i class="fa fa-filter"></i> Filters
        </button>
    </div>
</div>

<!-- Filter Panel -->
<div class="collapse {% if date_from or date_to or entry_type or subscriber_search %}show{% endif %}" id="filterPanel">
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row">
                <div class="col-md-2">
                    <label class="small font-weight-bold">Date From:</label>
                    <input type="date" name="date_from" value="{{ date_from }}" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <label class="small font-weight-bold">Date To:</label>
                    <input type="date" name="date_to" value="{{ date_to }}" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <label class="small font-weight-bold">Entry Type:</label>
                    <select name="entry_type" class="form-control form-control-sm">
                        <option value="">All Types</option>
                        {% for value, label in entry_type_choices %}
                        <option value="{{ value }}" {% if entry_type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold">Subscriber:</label>
                    <input type="text" name="subscriber" value="{{ subscriber_search }}" 
                           placeholder="Account # or Name" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold">&nbsp;</label><br>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fa fa-search"></i> Apply Filters
                    </button>
                    <a href="{% url 'general-ledger' %}" class="btn btn-secondary btn-sm">
                        <i class="fa fa-times"></i> Clear
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h5>₱{{ totals.total_debits|default:0|floatformat:2 }}</h5>
                <small>Total Debits</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5>₱{{ totals.total_credits|default:0|floatformat:2 }}</h5>
                <small>Total Credits</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h5>₱{{ totals.net_amount|default:0|floatformat:2 }}</h5>
                <small>Net Amount</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h5>{{ total_count }}</h5>
                <small>Total Entries</small>
            </div>
        </div>
    </div>
</div>

<!-- Summary by Type -->
{% if type_summary %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="fa fa-chart-pie"></i> Summary by Transaction Type
            </div>
            <div class="card-body">
                <div class="row">
                    {% for summary in type_summary %}
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-primary">{{ summary.entry_type }}</h6>
                            <div class="small">
                                <strong>Count:</strong> {{ summary.type_count }}<br>
                                <strong>Debits:</strong> ₱{{ summary.type_debits|default:0|floatformat:2 }}<br>
                                <strong>Credits:</strong> ₱{{ summary.type_credits|default:0|floatformat:2 }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Ledger Entries Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="row">
                    <div class="col-md-8">
                        <i class="fa fa-list"></i> Ledger Entries
                    </div>
                    <div class="col-md-4 text-right">
                        <small>
                            Showing {% if entries %}{{ entries.count }}{% else %}0{% endif %} 
                            of {{ total_count }} entries
                        </small>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if entries %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th width="8%">Date</th>
                                <th width="15%">Subscriber</th>
                                <th width="10%">Type</th>
                                <th width="25%">Description</th>
                                <th width="10%" class="text-right">Debit</th>
                                <th width="10%" class="text-right">Credit</th>
                                <th width="10%" class="text-right">Balance</th>
                                <th width="12%">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr class="{% if entry.entry_type == 'PAYMENT' %}table-success{% elif entry.entry_type == 'BILLING' %}table-light{% elif entry.entry_type == 'PENALTY' %}table-warning{% endif %}">
                                <td class="small">
                                    {{ entry.entry_date|date:"M d, Y" }}
                                </td>
                                <td class="small">
                                    <a href="{% url 'subscriber-detail' entry.subscriber.pk %}" class="text-decoration-none">
                                        <strong>{{ entry.subscriber.account_number }}</strong><br>
                                        <small class="text-muted">{{ entry.subscriber.last_name }}</small>
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-{% if entry.entry_type == 'PAYMENT' %}success{% elif entry.entry_type == 'BILLING' %}primary{% elif entry.entry_type == 'PENALTY' %}warning{% else %}secondary{% endif %}">
                                        {{ entry.get_entry_type_display }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ entry.description }}
                                    {% if entry.bill %}
                                        <br><small class="text-muted">
                                            <i class="fa fa-file-text"></i> 
                                            <a href="{% url 'bill-detail' entry.bill.pk %}" class="text-muted">
                                                Bill #{{ entry.bill.pk }}
                                            </a>
                                        </small>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if entry.debit > 0 %}
                                        <span class="text-danger font-weight-bold">
                                            ₱{{ entry.debit|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if entry.credit > 0 %}
                                        <span class="text-success font-weight-bold">
                                            ₱{{ entry.credit|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-right font-weight-bold">
                                    <span class="{% if entry.running_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                        ₱{{ entry.running_balance|floatformat:2 }}
                                    </span>
                                </td>
                                <td class="small">
                                    {% if entry.or_number %}
                                        <i class="fa fa-receipt"></i> {{ entry.or_number }}<br>
                                    {% endif %}
                                    {% if entry.received_by %}
                                        <small class="text-muted">{{ entry.received_by }}</small>
                                    {% endif %}
                                    {% if entry.created_at %}
                                        <br><small class="text-muted">{{ entry.created_at|date:"g:i A" }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="thead-light">
                            <tr>
                                <td colspan="4" class="text-right font-weight-bold">
                                    <strong>Page Totals:</strong>
                                </td>
                                <td class="text-right font-weight-bold text-danger">
                                    ₱{{ totals.total_debits|default:0|floatformat:2 }}
                                </td>
                                <td class="text-right font-weight-bold text-success">
                                    ₱{{ totals.total_credits|default:0|floatformat:2 }}
                                </td>
                                <td class="text-right font-weight-bold">
                                    <span class="{% if totals.net_amount > 0 %}text-danger{% else %}text-success{% endif %}">
                                        ₱{{ totals.net_amount|default:0|floatformat:2 }}
                                    </span>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% if total_count > 100 %}
                <div class="alert alert-info m-3">
                    <i class="fa fa-info-circle"></i> 
                    Showing first 100 entries of {{ total_count }} total. Use filters to narrow down the results.
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-5">
                    <i class="fa fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Entries Found</h5>
                    <p class="text-muted">Try adjusting your search filters.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
@media print {
    .btn, #filterPanel { display: none !important; }
    .card { border: none !important; }
    .card-header { background: white !important; color: black !important; }
    .table { font-size: 11px; }
    .badge { border: 1px solid #333; }
}
</style>
{% endblock %}