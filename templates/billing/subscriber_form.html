{% extends 'billing/base.html' %}
{% block title %}{% if form.instance.pk %}Edit Subscriber{% else %}Add New Subscriber{% endif %} - Macrohon Water Billing{% endblock %}
{% block page_title %}{% if form.instance.pk %}Edit Subscriber{% else %}Add New Subscriber{% endif %}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h4>
            <i class="fa fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
            {% if form.instance.pk %}Edit Subscriber: {{ form.instance.full_name }}{% else %}Add New Subscriber{% endif %}
        </h4>
    </div>
    <div class="col-md-4 text-right">
        <a href="{% url 'subscriber-list' %}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> Back to Subscribers
        </a>
        {% if form.instance.pk %}
        <a href="{% url 'subscriber-detail' form.instance.pk %}" class="btn btn-outline-primary">
            <i class="fa fa-eye"></i> View Details
        </a>
        {% endif %}
    </div>
</div>

<!-- Display Form Errors -->
{% if form.errors %}
<div class="alert alert-danger">
    <h6><i class="fa fa-exclamation-triangle"></i> Please correct the following errors:</h6>
    <ul class="mb-0">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <li><strong>{{ field|capfirst }}:</strong> {{ error }}</li>
            {% endfor %}
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Form Card -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fa fa-user"></i> Subscriber Information
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Personal Information Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="fa fa-user-circle"></i> Personal Information
                            </h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-id-card"></i> Account Number *
                                </label>
                                {{ form.account_number }}
                                <small class="form-text text-muted">Format: MHN-YYYY-NNNN</small>
                                {% if form.account_number.errors %}
                                    <div class="text-danger">{{ form.account_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">First Name *</label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger">{{ form.first_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">Last Name *</label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger">{{ form.last_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">Middle Name</label>
                                {{ form.middle_name }}
                                {% if form.middle_name.errors %}
                                    <div class="text-danger">{{ form.middle_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">Suffix</label>
                                {{ form.suffix }}
                                <small class="form-text text-muted">Jr., Sr., III, etc.</small>
                                {% if form.suffix.errors %}
                                    <div class="text-danger">{{ form.suffix.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-tag"></i> Classification *
                                </label>
                                {{ form.classification }}
                                {% if form.classification.errors %}
                                    <div class="text-danger">{{ form.classification.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="text-info border-bottom pb-2">
                                <i class="fa fa-address-book"></i> Contact Information
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-home"></i> Address *
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <div class="text-danger">{{ form.address.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">Barangay *</label>
                                {{ form.barangay }}
                                {% if form.barangay.errors %}
                                    <div class="text-danger">{{ form.barangay.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">Service Address</label>
                                {{ form.service_address }}
                                <small class="form-text text-muted">Leave blank if same as address above</small>
                                {% if form.service_address.errors %}
                                    <div class="text-danger">{{ form.service_address.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-phone"></i> Contact Number
                                </label>
                                {{ form.contact_number }}
                                <small class="form-text text-muted">e.g., 09123456789</small>
                                {% if form.contact_number.errors %}
                                    <div class="text-danger">{{ form.contact_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-envelope"></i> Email Address
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger">{{ form.email.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Meter Information Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="text-success border-bottom pb-2">
                                <i class="fa fa-tachometer-alt"></i> Meter Information
                            </h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-hashtag"></i> Meter Number *
                                </label>
                                {{ form.meter_number }}
                                {% if form.meter_number.errors %}
                                    <div class="text-danger">{{ form.meter_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">Meter Size</label>
                                {{ form.meter_size }}
                                <small class="form-text text-muted">Default: 1/2 inch</small>
                                {% if form.meter_size.errors %}
                                    <div class="text-danger">{{ form.meter_size.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-calendar"></i> Connection Date *
                                </label>
                                {{ form.connection_date }}
                                {% if form.connection_date.errors %}
                                    <div class="text-danger">{{ form.connection_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="text-warning border-bottom pb-2">
                                <i class="fa fa-cog"></i> Account Settings
                            </h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-toggle-on"></i> Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fa fa-peso-sign"></i> Monthly Minimum
                                </label>
                                {{ form.monthly_minimum }}
                                <small class="form-text text-muted">Will be set based on classification</small>
                                {% if form.monthly_minimum.errors %}
                                    <div class="text-danger">{{ form.monthly_minimum.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4 pt-2">
                                {{ form.is_senior }}
                                <label class="form-check-label font-weight-bold" for="{{ form.is_senior.id_for_label }}">
                                    <i class="fa fa-user-clock text-warning"></i> Senior Citizen (20% Discount)
                                </label>
                                <small class="form-text text-muted">Check if subscriber is a senior citizen</small>
                                {% if form.is_senior.errors %}
                                    <div class="text-danger">{{ form.is_senior.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-md-12">
                            <hr>
                            <div class="text-right">
                                <a href="{% url 'subscriber-list' %}" class="btn btn-secondary mr-2">
                                    <i class="fa fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fa fa-save"></i> 
                                    {% if form.instance.pk %}Update Subscriber{% else %}Add Subscriber{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Help Card -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fa fa-info-circle"></i> Help & Guidelines</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Account Numbers</h6>
                        <p class="small text-muted">
                            Use format: <strong>MHN-YYYY-NNNN</strong><br>
                            Example: MHN-2026-004
                        </p>
                        <h6 class="text-primary">Classifications</h6>
                        <ul class="small text-muted">
                            <li><strong>Private:</strong> Residential customers</li>
                            <li><strong>Commercial:</strong> Business establishments</li>
                            <li><strong>Government:</strong> Government offices</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Senior Citizens</h6>
                        <p class="small text-muted">
                            Senior citizens automatically receive 20% discount on their water bills as per RA 9994.
                        </p>
                        <h6 class="text-primary">Required Fields</h6>
                        <p class="small text-muted">
                            Fields marked with <span class="text-danger">*</span> are required and must be filled out.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-generate account number if adding new subscriber
    {% if not form.instance.pk %}
    if ($('#id_account_number').val() === '') {
        // Generate next account number (this is a simple example)
        var currentYear = new Date().getFullYear();
        $('#id_account_number').attr('placeholder', 'MHN-' + currentYear + '-XXX');
    }
    {% endif %}
    
    // Copy address to service address if service address is empty
    $('#id_address, #id_barangay').on('blur', function() {
        if ($('#id_service_address').val() === '') {
            var address = $('#id_address').val();
            var barangay = $('#id_barangay').val();
            if (address && barangay) {
                $('#id_service_address').val(address + ', ' + barangay + ', Macrohon');
            }
        }
    });
    
    // Set default monthly minimum based on classification
    $('#id_classification').on('change', function() {
        var classification = $(this).val();
        var monthlyMinimum = $('#id_monthly_minimum');
        
        if (monthlyMinimum.val() === '' || monthlyMinimum.val() === '0.00') {
            switch(classification) {
                case 'PRIVATE':
                    monthlyMinimum.val('150.00');
                    break;
                case 'COMMERCIAL':
                    monthlyMinimum.val('250.00');
                    break;
                case 'GOVERNMENT':
                    monthlyMinimum.val('200.00');
                    break;
            }
        }
    });
});
</script>
{% endblock %}